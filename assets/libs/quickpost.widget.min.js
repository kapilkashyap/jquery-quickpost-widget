/*
 * jQuery Quick Post UI Widget 1.0
 * Copyright (c) 2012 Kapil Kashyap
 *
 * Depends:
 *   - jQuery 1.6+
 *   - jQuery UI 1.8 widget factory
 *   - jQuery paginateddropdown widget
 *   - jQuery Filter Json plugin // optional
 *
 * Dual licensed under the MIT and GPL licenses:
 *   - http://www.opensource.org/licenses/mit-license.php
 *   - http://www.gnu.org/licenses/gpl.html
 */
(function(e){e.widget("kk.quickpost",e.kk.paginateddropdown,{options:{triggerOn:"@",identifierProperty:"id",autoHeight:true,increaseHeightAfter:75,deltaHeight:20},_create:function(){var t=null,n=null,r=null,i=0;this._setWidgetProperties();t=e("<div></div>").addClass(this.wp.widgetBaseClass+this.wp.hyphen+this.wp.wrapperLabel);this.element.wrap(t.width(this.element.width()));this._setWidgetState();this.element.addClass(this.wp.widgetBaseClass);if(this.options.dropdownWidth){i=parseInt(this.options.dropdownWidth,10);this.options.dropdownWidth=i?i:0}r=parseInt(this.options.itemsPerPage,10);if(!r||r<=0){this.options.itemsPerPage=10}n=e("<input></input>",{type:"hidden",value:"",name:"x_"+this.wp.widgetBaseClass+"_hidden_input","class":"x-"+this.wp.widgetBaseClass+"-hidden-input"});this.element.parent().append(n);this._bindEvents();this._constructPaginationFooterTemplate()},_setWidgetProperties:function(){if(this.options.customEventPrefix){this.widgetEventPrefix=this.options.customEventPrefix}this.wp={};this.wp.widgetBaseClass="quickpost";this.wp.selectedItemClass="selected-item";this.wp.space=" ";this.wp.hyphen="-";this.wp.ofLabel="of";this.wp.wrapperLabel="wrapper";this.wp.containerLabel="container";this.wp.itemLabel="item";this.wp.footerLabel="footer";this.wp.footerContentLabel="footer-content";this.wp.footerInfoLabel="footer-info";this.wp.footerLeftNavLabel="footer-left-nav";this.wp.footerRightNavLabel="footer-right-nav";this.wp.closeBtnLabel="close-button";this.wp.itemSelectedEvent="itemselected";this.wp.fireAjaxRegEx=new RegExp("\\s"+this.options.triggerOn+"\\w+");this.wp.fireAjaxRegEx2=new RegExp(this.options.triggerOn+"\\w+");this.wp.contentEditableRegEx=new RegExp('\\s?contenteditable=("false"|false)\\s?',"ig");this.wp.breakLineRegEx=new RegExp("<br>","ig");this.wp.openingTagRegEx=new RegExp("\\<button\\s?|\\<b\\s?","ig");this.wp.closingTagRegEx=new RegExp("</button>|</b>","ig");this.wp.pidRegEx=new RegExp('s?pid="',"ig");this.wp.nbspRegEx=new RegExp(" ","g");this.wp.delimeterRegEx=new RegExp('">',"g");this.wp.typeRegEx=new RegExp("\\s?type=submit\\s?","ig");this.wp.spanRegEx=new RegExp('<span contenteditable=("true"|true)>|</span>',"ig");this.wp.mailToPrefixRegEx=new RegExp('<a href="mailto:\\w+\\.?(\\w+)?\\@\\w+">',"ig");this.wp.mailToSuffixRegEx=new RegExp("</a>","ig");this.wp.emptyString="";this.wp.enclosurePrefix="@[";this.wp.enclosureDelimeter=":";this.wp.enclosureSuffix="]";this.wp.elOriginalHeight=this.element.height()},_bindEvents:function(){var t=this,n=t.element,r=null;n.keydown(function(i){t._keyNavigations(i);if(e.browser.mozilla){if(i.keyCode==8||i.keyCode==46){r=document.getSelection();if(r&&r.toString()!=""){if(i.keyCode==8){i.preventDefault()}r.deleteFromDocument();t._updateHiddenInput();n.focus()}}}if(t.options.autoHeight){t._setElHeight(n.text().length)}});n.keypress(function(r){if(r.keyCode==13){r.preventDefault();if(e(n.parent().find("."+t.wp.selectedItemClass)).length>0){t._itemSelection(r)}return}});n.keyup(function(e){var r=null,i=n.text();if(i==""||e.keyCode==27){if(i==""||!t.options.persistState){if(i==""){n.siblings(".x-"+t.wp.widgetBaseClass+"-hidden-input").val("");n.html("")}t._resetWidgetState()}t._cleanup();return}t._updateHiddenInput();if(i.match(t.wp.fireAjaxRegEx)||i.search(t.wp.fireAjaxRegEx2)!=-1){var s=0,o=null,u="",a=-1,f="",l=function(e,t){if(!t){return e}if(t.innerText||t.innerHTML){e=e+(t.innerText||t.innerHTML).length}else if(t.data){e=e+t.data.length}return l(e,t.previousSibling)};if(window.getSelection){r=window.getSelection().getRangeAt(0);s=l(r.startOffset,r.endContainer.previousSibling)}else if(document.selection){r=document.selection.createRange();o=document.body.createTextRange();o.moveToElementText(this);o.setEndPoint("EndToEnd",r);s=o.text.length}u=i.substring(0,s),a=u.lastIndexOf(t.options.triggerOn),f=a!=-1?u.substring(a+1):"";if(f!=""){t._fetchData(f)}else{t._cleanup()}}else{t._cleanup()}});n.blur(function(e){setTimeout(function(){if(n.is(":focus")){return false}t._resetWidgetState();t._cleanup()},200)});n.click(function(t){if(e.browser.msie){try{document.execCommand("AutoUrlDetect",false,false)}catch(n){}}})},_setElHeight:function(e){var t=null,n=null;if(e>1){n=Math.floor(e/this.options.increaseHeightAfter);t=this.wp.elOriginalHeight+n*this.options.deltaHeight;if(t!=this.element.height()){this.element.height(t)}}else if(e==0){this.element.height(this.wp.elOriginalHeight)}},_updateContent:function(t){var n=this,r=n.element,i=this.options.triggerOn+n._getWidgetState().query,s=r.html(),o=s.indexOf(i),u=null;s=e.trim(s);if(e.browser.mozilla){u=s.replace(i,'<button pid="'+t[n.options.identifierProperty]+'" contentEditable="false"><span contenteditable="true">'+t[n.options.valueProperty]+"</span></button> ")}else{if(e.browser.msie){if(s.charAt(o-1)==" "){s=s.substring(0,o-1)+" "+s.substring(o,s.length+6)}}u=s.replace(i,'<button pid="'+t[n.options.identifierProperty]+'" contentEditable="false">'+t[n.options.valueProperty]+"</button> ")+(!e.browser.msie?"<br>":"")}r.html(u);n._updateHiddenInput(t[n.options.valueProperty]);r.focus()},_updateHiddenInput:function(t){var n=this.element.siblings(".x-"+this.wp.widgetBaseClass+"-hidden-input"),r=this.element.html(),i=null,s=t?this.element.text().indexOf(t)+t.length+1:0;if(e.browser.msie&&parseInt(e.browser.version,10)<=8){r=r.replace(this.wp.mailToPrefixRegEx,this.wp.emptyString).replace(this.wp.mailToSuffixRegEx,this.wp.emptyString)}i=r.replace(this.wp.spanRegEx,this.wp.emptyString).replace(this.wp.typeRegEx,this.wp.emptyString).replace(this.wp.breakLineRegEx,this.wp.emptyString).replace(this.wp.contentEditableRegEx,this.wp.emptyString).replace(this.wp.pidRegEx,this.wp.enclosurePrefix).replace(this.wp.delimeterRegEx,this.wp.enclosureDelimeter).replace(this.wp.openingTagRegEx,this.wp.emptyString).replace(this.wp.closingTagRegEx,this.wp.enclosureSuffix).replace(this.wp.nbspRegEx,this.wp.space);n.val(e("<div></div>").html(i).text());s>0&&this._setCaretPositionAfter(t,s)},_setCaretPositionAfter:function(t,n){var r=null,i=null,s=0,o=null,u=null,a=null;this.element.focus();if(window.getSelection){a=window.getSelection();r=a.getRangeAt(0);i=this.element[0].childNodes;if(i.length>0){e.each(i,function(e,n){if(n.textContent&&t==n.textContent){s=e}});try{r.setStart(i[s+1],1);r.collapse(true);a.removeAllRanges();a.addRange(r)}catch(f){if(window.console){console.error(f)}}}}},destroy:function(){this.element.siblings(".x-"+this.wp.widgetBaseClass+"-hidden-input").remove();if(this.options.autoHeight){this.element.height(this.wp.elOriginalHeight)}e.kk.paginateddropdown.prototype.destroy.call(this)}});e.extend(e.kk.quickpost.prototype.options,e.kk.paginateddropdown.prototype.options)})(jQuery)